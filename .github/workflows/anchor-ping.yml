name: Call OpenAI (print headers/body)
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  run: |
    set -e
    if [ -z "${OPENAI_API_KEY:-}" ]; then
      echo "ERROR: Missing OPENAI_API_KEY secret"; exit 1; fi

    # payload สั้น ๆ
    JSON='{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ANCHOR: Reply with exactly: OK"}]}'

    # ยิงแล้วเก็บ header/body แยกไฟล์
    curl -sS -X POST https://api.openai.com/v1/chat/completions \
      -H "Authorization: Bearer $OPENAI_API_KEY" \
      -H "Content-Type: application/json" \
      -d "$JSON" \
      -D /tmp/headers.txt \
      -o /tmp/body.json

    echo "----- HEADERS -----"
    cat /tmp/headers.txt
    echo "----- BODY -----"
    cat /tmp/body.json

    # ดึงสถานะ HTTP
    CODE=$(awk 'BEGIN{c=0} /^HTTP/{c=$2} END{print c}' /tmp/headers.txt)
    echo "HTTP CODE: $CODE"

    # ถ้า error ก็จบด้วยรหัส 1
    [ "$CODE" -lt 400 ] || exit 1

    # ปกติพิมพ์คำตอบ
    jq -r '.choices[0].message.content' /tmp/body.json || true
