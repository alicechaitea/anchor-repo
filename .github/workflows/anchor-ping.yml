name: Anti-Cream Anchor (debug)

on:
  workflow_dispatch:
  schedule:
    - cron: "0,30 18-23,0-5 * * *"   # ทุกครึ่งชั่วโมง 01:00–12:00 (Bangkok)

jobs:
  anchor:
    runs-on: ubuntu-latest
    steps:
      - name: Call OpenAI (print headers/body)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "ERROR: Missing OPENAI_API_KEY secret"; exit 1; fi

          JSON='{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ANCHOR: Reply with exactly: OK"}]}'

          curl -sS -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            -D /tmp/headers.txt \
            -o /tmp/body.json

          echo "----- HEADERS -----"
          cat /tmp/headers.txt
          echo "----- BODY -----"
          cat /tmp/body.json

          CODE=$(awk 'BEGIN{c=0} /^HTTP/{c=$2} END{print c}' /tmp/headers.txt)
          echo "HTTP CODE: $CODE"

          [ "$CODE" -lt 400 ] || exit 1

          jq -r '.choices[0].message.content' /tmp/body.json || true
