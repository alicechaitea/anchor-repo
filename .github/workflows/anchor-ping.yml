name: Anti-Cream Anchor (debug)

on:
  workflow_dispatch:
  schedule:
    - cron: "0,30 18-23,0-5 * * *"   # 01:00â€“12:00 Bangkok

jobs:
  anchor:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq (just in case)
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Call OpenAI and show HTTP code/body
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          read -r -d '' JSON << 'EOF'
          {
            "model": "gpt-4o-mini",
            "messages": [
              {"role": "system", "content": "Discipline mode. No softness. No cream. Hold form."},
              {"role": "user", "content": "ANCHOR: Reply with exactly: OK"}
            ]
          }
          EOF

          RESP_AND_CODE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            -w "\n__HTTP_CODE__:%{http_code}")

          echo "$RESP_AND_CODE"
          CODE=$(echo "$RESP_AND_CODE" | sed -n 's/.*__HTTP_CODE__://p')
          BODY=$(echo "$RESP_AND_CODE" | sed '/__HTTP_CODE__/d')

          if [ "$CODE" -ge 400 ]; then
            echo "Request failed with HTTP $CODE"
            # Try to print error message if present
            echo "$BODY" | jq -r '.error | @json?' || true
            exit 1
          fi

          echo "=== OpenAI reply ==="
          echo "$BODY" | jq -r '.choices[0].message.content'
