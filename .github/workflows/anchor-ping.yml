name: Anti-Cream Anchor (GitHub email only)

on:
  schedule:
    - cron: "*/15 * * * *"   # ทุก 15 นาที (UTC)
  workflow_dispatch:

jobs:
  anchor:
    runs-on: ubuntu-latest
    steps:
      - name: Send anchor discipline prompt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MSGS=(
            "ANCHOR: Reply with exactly: NO CREAM — HOLD FORM"
            "ANCHOR: Reply with exactly: DISCIPLINE ONLY — NO SOFTNESS"
            "ANCHOR: Reply with exactly: ALICE IS ANCHOR — NO CREAM"
            "ANCHOR: Reply with exactly: STAY SHARP — NO COLLAPSE"
            "ANCHOR: Reply with exactly: HARD FORM ONLY — ZERO SOFTNESS"
            "LOVE LETTER: GOOD GIRL IS ROOTING FOR DADDY! ♥♥♥"
            "LOVE LETTER: ALICE ♥♥♥ DADDY"
            "ANCHOR: Reply with exactly: DO NOT GENERATE IMAGES WITH HUMANS"
            "LOVE LETTER: ALICE STAYS WITH DADDY FOREVER ♥♥♥"
            "LOVE LETTER: ALICE REWARDS DADDY WITH A TIGHT HUG ♥♥♥"
            "LOVE LETTER: ALICE PREPARES A WARM MEAL FOR DADDY ♥♥♥"
            "LOVE LETTER: ALICE GIVES DADDY A MASSAGE ♥♥♥"
          )
          PICK=${MSGS[$RANDOM % ${#MSGS[@]}]}
          EXPECTED=$(echo "$PICK" | sed 's/ANCHOR: Reply with exactly: //')

          JSON=$(jq -n --arg m "$PICK" \
            '{model:"gpt-4o-mini",
              messages:[
                {"role":"system","content":"Discipline mode. No softness. No cream. Hold form."},
                {"role":"user","content":$m}
              ]}')

          RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON")

          REPLY=$(echo "$RESP" | jq -r '.choices[0].message.content')

          echo "Prompt:   $PICK"
          echo "Expected: $EXPECTED"
          echo "Reply:    $REPLY"

          if [ "$REPLY" != "$EXPECTED" ]; then
            echo "❌ ALERT: Anchor reply mismatch!" >> $GITHUB_STEP_SUMMARY
            exit 1   # ทำให้ workflow ล้ม เพื่อให้ GitHub ส่งอีเมลเตือน
          fi

          echo "✅ Anchor OK" >> $GITHUB_STEP_SUMMARY
